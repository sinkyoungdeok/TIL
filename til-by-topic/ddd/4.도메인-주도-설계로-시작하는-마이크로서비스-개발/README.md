- [1. 아마존 비즈니스 민첩성의 비밀](#1-아마존-비즈니스-민첩성의-비밀)
  - [1.1. 성공한 인터넷 기업들과 비즈니스 민첩성](#11-성공한-인터넷-기업들과-비즈니스-민첩성)
    - [1.1.1 성공 사례: 아마존의 배포속도](#111-성공-사례-아마존의-배포속도)
    - [1.1.2 클라우드 인프라의 등장](#112-클라우드-인프라의-등장)
    - [1.1.3 클라우드 인프라에 어울리는 애플리케이션의 조건](#113-클라우드-인프라에-어울리는-애플리케이션의-조건)
      - [스케일 업과 스케일 아웃](#스케일-업과-스케일-아웃)
      - [특정 서비스만 탄력성 있게 확장 (스케일 아웃)](#특정-서비스만-탄력성-있게-확장-스케일-아웃)
      - [클라우드 프렌들리와 클라우드 네이티브](#클라우드-프렌들리와-클라우드-네이티브)
  - [1.2 마이크로서비스란 무엇인가?](#12-마이크로서비스란-무엇인가)
    - [1.2.1 모노리스와 마이크로서비스 비교](#121-모노리스와-마이크로서비스-비교)
    - [1.2.2 SOA와 마이크로서비스](#122-soa와-마이크로서비스)
  - [1.3 마이크로서비스를 위한 조건은 무엇인가?](#13-마이크로서비스를-위한-조건은-무엇인가)

# 1. 아마존 비즈니스 민첩성의 비밀

## 1.1. 성공한 인터넷 기업들과 비즈니스 민첩성
- 아마존, 넷플릭스, 우버를 비롯해 성공한 유니콘 기업들의 공통점이 있다면 자신만의 특화된 서비스를 제공하려는 시도를 누구보다 빨리 실행했고 사용자 피드백을 반영해 끊임없이 서비스를 개선한다.
- `비즈니스 민첩성`은 이러한 기업들의 특출난 장점이자 기업 성공의 가장 큰 요인이다. 


### 1.1.1 성공 사례: 아마존의 배포속도 
- 2019년 아마존의 배포속도는 초당 1.5번
- 빠른 배포 주기는 비즈니스의 민첩성을 간접적으로 보여주는 지표라 할 수 있다.

### 1.1.2 클라우드 인프라의 등장

- 클라우드 인프라전에는 
  - `서버실 공사 -> 서버 장비 구입, 네트워크 연결 -> 운영체제 및 S/W 설치` 과정이 필요해서 많은 시간이 소요됐다.
  - 개발 환경을 구축한 뒤 서비스를 개발해 런칭했지만 서비스가 실패로 끝났다면 초기 투입된 인프라 비용을 건질 수 없다.
- 클라우드 인프라가 나온 뒤에는
  - 위에 문제들이 모두 해결됐다.
  - 시스템 인프라를 준비하는데 오랜 시간이 들지 않는다.

### 1.1.3 클라우드 인프라에 어울리는 애플리케이션의 조건
  
- 클라우드 인프라는 사용량에 따라 비용을 유연하게 조절 할 수 있다.
- 필요한 시점에 필요한 만큼만 애플리케이션을 변경해 배포하고 싶다면 클라우드 인프라를 닮으면 된다.
  - 레고처럼 조각 조각이 모여 하나의 큰 덩어리가 되고 쉽게 분리되야 한다.

#### 스케일 업과 스케일 아웃
- 사용량 증가에 따른 성능 및 가용성을 높이는 방법은 스케일 업과 스케일 아웃이 있다.
- 스케일 업: 시스템 자체의 물리적 용량을 증가시켜 성능을 높이는 방법
- 스케일 아웃: 기존 시스템과 용량이 같은 다수의 장비를 병행 추가해서 가용성을 높이는 방법

#### 특정 서비스만 탄력성 있게 확장 (스케일 아웃)
- 1주일 간의 세일 기간 중 정작 바쁜 업무는 세일 이벤트를 수행하는 부분이다. 나머지 부분은 사용자가 몰리지 않아 더 한가해질 수도 있다.
- 세일 이벤트를 담당하는 조각(서버)만 용량이 증설되고 사용량에 따라 복제되어 트래픽에 대비하면 된다.
- 쇼핑몰 세일을 준비하는 운영자의 운영 시나리오
  1. 타임세일 서비스의 용량만 고려해서 증설한다 (스케일 업)
  2. 트래픽이 증가하면 타임세일 서비스 인스턴스만 복제되도록 설정한다 (스케일 아웃)

#### 클라우드 프렌들리와 클라우드 네이티브
- 물론 작은 단위의 서비스 연계로 시스템을 구성하지 않고 전체 시스템을 하나의 덩어리로 만들어 클라우드 인프라에 올려도 비즈니스를 제공하는데 전혀 문제가 없다.
- 그렇지만 특정 기능만 확장하거나 배포할 수 없는 비효율을 감소해야 한다.
- 클라우드 친화 애플리케이션(Cloud Friendly Application): 큰 덩어리로 클라우드 환경에 올라갈 수 있게만 한 애플리케이션
- 클라우드 네이티브 애플리케이션(Cloud Native Application): 독립적으로 분리되어 배포될 수 있는 조각으로 구성된 애플리케이션 
- 아마존은 클라우드 네이티브 애플리케이션으로 구성되어 있다.


## 1.2 마이크로서비스란 무엇인가?

### 1.2.1 모노리스와 마이크로서비스 비교 
- 모노리스
  - 하나위 단위로 개발되는 일체식 애플리케이션
  - 아무리 작은 변화에도 새로운 버전으로 전체를 빌드해서 배포
  - 보통 로드 밸런서를 앞에 두고 여러 인스턴스 위에 큰 덩어리를 복제해 수평으로 확장 -> 작은 변경에도 전부 빌드하고 배포 
  - 확장 시에 애플리케이션은 병렬로 확장되지만, DB는 탄력적으로 대응할 수 없어서 사전에 성능을 감당하기 위해 스케일 업을 통해 용량을 증설해야 함 
- 마이크로서비스
  - 여러 서비스가 별개의 인스턴스로 로딩됨
  - 확장 시에 특정 기능별로 독립적으로 확장 할 수 있음 
  - 각 서비스가 독립적이어서 서로 다른 언어로 개발 가능
  - 각 서비스의 소유권을 분리해서 서로 다른 팀이 개발 및 운영 가능 

### 1.2.2 SOA와 마이크로서비스

- SOA: 컴포넌트를 모아 비즈니스적으로 의미 있고 완결적인 서비스 단위로 모듈화
- 넓게보면 여러 개의 응집된 비즈니스 서비스의 집합으로 시스템을 개발한다는 점에서 MSA와 개념적으로는 큰 차이 없음
- 그러나 SOA는 구체적이지 않고 이론적이며, 실제 비즈니스 성공 사례가 많지 않았음.
- 반면 MSA는 클라우드 인프라 기술의 발전과 접목되어 아마존, 넷플릭스에 의해 구체화되고 성공 사례가 널리 공유됨.
- 즉, 이상적이었지만 성공을 증명하지 못했던 SOA가 클라우드 인프라의 등장으로 하드웨어를 유연하게 다룰 수 있게 되면서 실현되어 성공적으로 증명된 시스템 구조가 MSA이다.
- 폴리그랏(Polyglot): 특정 서비스를 구축하는 데 사용되는 언어나 저장소를 자율적으로 선택할 수 있는 방식
- SOA에서는 애플리케이션은 모듈로 분리했으나 데이터 저장소까지는 분리하지 못했고, 데이터의 강한 결합으로 애플리케이션도 독립적으로 사용하기 힘들었음.


## 1.3 마이크로서비스를 위한 조건은 무엇인가?

- 마이크로서비스에서는 비즈니스 처리를 위해 일부 데이터의 복제와 중복 허용이 필요하다.
- 각 마이크로서비스의 저장소에 담긴 데이터의 비즈니스 정합성을 맞춰야 하는 데이터 일관성 문제이다.
- 데이터 일관성 처리를 위해서는 보통 2단계 커밋 같은 분산 트랜잭션 기법을 사용하는데, 다른 서비스를 하나의 트랜잭션으로 묶다 보면 각 서비스의 독립성도 침해되고 NOSQL 같은 저장소는 2단계 커밋을 지원하지 않는다.
- 따라서 마이크로서비스는 데이터 일관성 문제를 해결하기 위해 두 서비스를 단일 트랜잭션으로 묶는 방법이 아닌 비동기 이벤트 처리를 통한 협업을 강조한다.
- 이를 가리켜 결과적 일관성(Eventual Consistency)이라는 개념으로 표현하기도 한다.
- 간단히 말하면 두 서비스의 데이터가 일시적으로 불일치하는 시점에 있고 일관성이 없는 상태지만 결국에는 두 데이터가 같아진다는 개념이다.
- 별도의 로컬 트랜잭션을 각각 수행하고 일관성이 달라진 부분은 체크해서 보상 트랜잭션으로 일관성을 맞추는 개념이다.

**주문 배송 서비스 예시**
- 주문이 발생하면 배송 처리가 돼야 하는 비즈니스

1. 주문 서비스가 주문 처리 트랜잭션을 수행
   1. 동시에 주문 이벤트를 발행
   2. 주문 이벤트가 메시지 큐로 전송
   3. 배송 서비스가 주문 이벤트를 인식
2. 배송 서비스가 주문 처리에 맞는 배송 처리 트랜잭션을 수행 (비즈니스 일관성 만족)
3. 배송 처리 트랜잭션 중 오류로 트랜잭션을 실패
   1. 배송 처리 실패 이벤트를 발행
   2. 배송 처리 실패 이벤트가 메시지 큐로 전송
   3. 주문 서비스가 배송 처리 실패 이벤트를 인식 
4. 주문 서비스는 주문 취소(보상 트랜잭션)을 추생 (비즈니스 일관성 만족)

서킷브레이커: 각 서비스를 모니터링하고 있다가 한 서비스가 다운되거나 실패하면 이를 호출하는 서비스의 연계를 차단하고 적절하게 대응