- [1. 아마존 비즈니스 민첩성의 비밀](#1-아마존-비즈니스-민첩성의-비밀)
  - [1.1. 성공한 인터넷 기업들과 비즈니스 민첩성](#11-성공한-인터넷-기업들과-비즈니스-민첩성)
    - [1.1.1 성공 사례: 아마존의 배포속도](#111-성공-사례-아마존의-배포속도)
    - [1.1.2 클라우드 인프라의 등장](#112-클라우드-인프라의-등장)
    - [1.1.3 클라우드 인프라에 어울리는 애플리케이션의 조건](#113-클라우드-인프라에-어울리는-애플리케이션의-조건)
      - [스케일 업과 스케일 아웃](#스케일-업과-스케일-아웃)
      - [특정 서비스만 탄력성 있게 확장 (스케일 아웃)](#특정-서비스만-탄력성-있게-확장-스케일-아웃)
      - [클라우드 프렌들리와 클라우드 네이티브](#클라우드-프렌들리와-클라우드-네이티브)
  - [1.2 마이크로서비스란 무엇인가?](#12-마이크로서비스란-무엇인가)
    - [1.2.1 모노리스와 마이크로서비스 비교](#121-모노리스와-마이크로서비스-비교)
    - [1.2.2 SOA와 마이크로서비스](#122-soa와-마이크로서비스)
  - [1.3 마이크로서비스를 위한 조건은 무엇인가?](#13-마이크로서비스를-위한-조건은-무엇인가)
- [2. MSA의 이해](#2-msa의-이해)
  - [2.1 리액티브 선언: 현대 애플리케이션이 갖춰야 할 바람직한 속성들](#21-리액티브-선언-현대-애플리케이션이-갖춰야-할-바람직한-속성들)
    - [소프트웨어 아키텍처](#소프트웨어-아키텍처)
    - [리액티브 선언문](#리액티브-선언문)
  - [2.2 강 결합에서 느슨한 결합의 아키텍처로의 변화](#22-강-결합에서-느슨한-결합의-아키텍처로의-변화)
    - [과거의 아키텍처](#과거의-아키텍처)
    - [최근의 아키텍처](#최근의-아키텍처)
    - [2.3 마이크로서비스의 외부 아키텍처와 내부 아키텍처](#23-마이크로서비스의-외부-아키텍처와-내부-아키텍처)

# 1. 아마존 비즈니스 민첩성의 비밀

## 1.1. 성공한 인터넷 기업들과 비즈니스 민첩성
- 아마존, 넷플릭스, 우버를 비롯해 성공한 유니콘 기업들의 공통점이 있다면 자신만의 특화된 서비스를 제공하려는 시도를 누구보다 빨리 실행했고 사용자 피드백을 반영해 끊임없이 서비스를 개선한다.
- `비즈니스 민첩성`은 이러한 기업들의 특출난 장점이자 기업 성공의 가장 큰 요인이다. 


### 1.1.1 성공 사례: 아마존의 배포속도 
- 2019년 아마존의 배포속도는 초당 1.5번
- 빠른 배포 주기는 비즈니스의 민첩성을 간접적으로 보여주는 지표라 할 수 있다.

### 1.1.2 클라우드 인프라의 등장

- 클라우드 인프라전에는 
  - `서버실 공사 -> 서버 장비 구입, 네트워크 연결 -> 운영체제 및 S/W 설치` 과정이 필요해서 많은 시간이 소요됐다.
  - 개발 환경을 구축한 뒤 서비스를 개발해 런칭했지만 서비스가 실패로 끝났다면 초기 투입된 인프라 비용을 건질 수 없다.
- 클라우드 인프라가 나온 뒤에는
  - 위에 문제들이 모두 해결됐다.
  - 시스템 인프라를 준비하는데 오랜 시간이 들지 않는다.

### 1.1.3 클라우드 인프라에 어울리는 애플리케이션의 조건
  
- 클라우드 인프라는 사용량에 따라 비용을 유연하게 조절 할 수 있다.
- 필요한 시점에 필요한 만큼만 애플리케이션을 변경해 배포하고 싶다면 클라우드 인프라를 닮으면 된다.
  - 레고처럼 조각 조각이 모여 하나의 큰 덩어리가 되고 쉽게 분리되야 한다.

#### 스케일 업과 스케일 아웃
- 사용량 증가에 따른 성능 및 가용성을 높이는 방법은 스케일 업과 스케일 아웃이 있다.
- 스케일 업: 시스템 자체의 물리적 용량을 증가시켜 성능을 높이는 방법
- 스케일 아웃: 기존 시스템과 용량이 같은 다수의 장비를 병행 추가해서 가용성을 높이는 방법

#### 특정 서비스만 탄력성 있게 확장 (스케일 아웃)
- 1주일 간의 세일 기간 중 정작 바쁜 업무는 세일 이벤트를 수행하는 부분이다. 나머지 부분은 사용자가 몰리지 않아 더 한가해질 수도 있다.
- 세일 이벤트를 담당하는 조각(서버)만 용량이 증설되고 사용량에 따라 복제되어 트래픽에 대비하면 된다.
- 쇼핑몰 세일을 준비하는 운영자의 운영 시나리오
  1. 타임세일 서비스의 용량만 고려해서 증설한다 (스케일 업)
  2. 트래픽이 증가하면 타임세일 서비스 인스턴스만 복제되도록 설정한다 (스케일 아웃)

#### 클라우드 프렌들리와 클라우드 네이티브
- 물론 작은 단위의 서비스 연계로 시스템을 구성하지 않고 전체 시스템을 하나의 덩어리로 만들어 클라우드 인프라에 올려도 비즈니스를 제공하는데 전혀 문제가 없다.
- 그렇지만 특정 기능만 확장하거나 배포할 수 없는 비효율을 감소해야 한다.
- 클라우드 친화 애플리케이션(Cloud Friendly Application): 큰 덩어리로 클라우드 환경에 올라갈 수 있게만 한 애플리케이션
- 클라우드 네이티브 애플리케이션(Cloud Native Application): 독립적으로 분리되어 배포될 수 있는 조각으로 구성된 애플리케이션 
- 아마존은 클라우드 네이티브 애플리케이션으로 구성되어 있다.


## 1.2 마이크로서비스란 무엇인가?

### 1.2.1 모노리스와 마이크로서비스 비교 
- 모노리스
  - 하나위 단위로 개발되는 일체식 애플리케이션
  - 아무리 작은 변화에도 새로운 버전으로 전체를 빌드해서 배포
  - 보통 로드 밸런서를 앞에 두고 여러 인스턴스 위에 큰 덩어리를 복제해 수평으로 확장 -> 작은 변경에도 전부 빌드하고 배포 
  - 확장 시에 애플리케이션은 병렬로 확장되지만, DB는 탄력적으로 대응할 수 없어서 사전에 성능을 감당하기 위해 스케일 업을 통해 용량을 증설해야 함 
- 마이크로서비스
  - 여러 서비스가 별개의 인스턴스로 로딩됨
  - 확장 시에 특정 기능별로 독립적으로 확장 할 수 있음 
  - 각 서비스가 독립적이어서 서로 다른 언어로 개발 가능
  - 각 서비스의 소유권을 분리해서 서로 다른 팀이 개발 및 운영 가능 

### 1.2.2 SOA와 마이크로서비스

- SOA: 컴포넌트를 모아 비즈니스적으로 의미 있고 완결적인 서비스 단위로 모듈화
- 넓게보면 여러 개의 응집된 비즈니스 서비스의 집합으로 시스템을 개발한다는 점에서 MSA와 개념적으로는 큰 차이 없음
- 그러나 SOA는 구체적이지 않고 이론적이며, 실제 비즈니스 성공 사례가 많지 않았음.
- 반면 MSA는 클라우드 인프라 기술의 발전과 접목되어 아마존, 넷플릭스에 의해 구체화되고 성공 사례가 널리 공유됨.
- 즉, 이상적이었지만 성공을 증명하지 못했던 SOA가 클라우드 인프라의 등장으로 하드웨어를 유연하게 다룰 수 있게 되면서 실현되어 성공적으로 증명된 시스템 구조가 MSA이다.
- 폴리그랏(Polyglot): 특정 서비스를 구축하는 데 사용되는 언어나 저장소를 자율적으로 선택할 수 있는 방식
- SOA에서는 애플리케이션은 모듈로 분리했으나 데이터 저장소까지는 분리하지 못했고, 데이터의 강한 결합으로 애플리케이션도 독립적으로 사용하기 힘들었음.


## 1.3 마이크로서비스를 위한 조건은 무엇인가?

- 마이크로서비스에서는 비즈니스 처리를 위해 일부 데이터의 복제와 중복 허용이 필요하다.
- 각 마이크로서비스의 저장소에 담긴 데이터의 비즈니스 정합성을 맞춰야 하는 데이터 일관성 문제이다.
- 데이터 일관성 처리를 위해서는 보통 2단계 커밋 같은 분산 트랜잭션 기법을 사용하는데, 다른 서비스를 하나의 트랜잭션으로 묶다 보면 각 서비스의 독립성도 침해되고 NOSQL 같은 저장소는 2단계 커밋을 지원하지 않는다.
- 따라서 마이크로서비스는 데이터 일관성 문제를 해결하기 위해 두 서비스를 단일 트랜잭션으로 묶는 방법이 아닌 비동기 이벤트 처리를 통한 협업을 강조한다.
- 이를 가리켜 결과적 일관성(Eventual Consistency)이라는 개념으로 표현하기도 한다.
- 간단히 말하면 두 서비스의 데이터가 일시적으로 불일치하는 시점에 있고 일관성이 없는 상태지만 결국에는 두 데이터가 같아진다는 개념이다.
- 별도의 로컬 트랜잭션을 각각 수행하고 일관성이 달라진 부분은 체크해서 보상 트랜잭션으로 일관성을 맞추는 개념이다.

**주문 배송 서비스 예시**
- 주문이 발생하면 배송 처리가 돼야 하는 비즈니스

1. 주문 서비스가 주문 처리 트랜잭션을 수행
   1. 동시에 주문 이벤트를 발행
   2. 주문 이벤트가 메시지 큐로 전송
   3. 배송 서비스가 주문 이벤트를 인식
2. 배송 서비스가 주문 처리에 맞는 배송 처리 트랜잭션을 수행 (비즈니스 일관성 만족)
3. 배송 처리 트랜잭션 중 오류로 트랜잭션을 실패
   1. 배송 처리 실패 이벤트를 발행
   2. 배송 처리 실패 이벤트가 메시지 큐로 전송
   3. 주문 서비스가 배송 처리 실패 이벤트를 인식 
4. 주문 서비스는 주문 취소(보상 트랜잭션)을 추생 (비즈니스 일관성 만족)

서킷브레이커: 각 서비스를 모니터링하고 있다가 한 서비스가 다운되거나 실패하면 이를 호출하는 서비스의 연계를 차단하고 적절하게 대응

# 2. MSA의 이해

- 모노리스에서 마이크로서비스 시스템으로 변화함에 따라 발생하는 문제점들을 해결하기 위해 등장했던 MSA 패턴들을 살펴보자.

## 2.1 리액티브 선언: 현대 애플리케이션이 갖춰야 할 바람직한 속성들

### 소프트웨어 아키텍처
- 소프트웨어를 구성하는 요소와 그 구성요소 간의 관게를 정의
- 아키텍처를 정의하는 과정: 비기능 요건(성능, 가용성, 보안, 유지보수성, 확장성 등)을 만족하는 다양한 해결 방법을 찾는 과정 

### 리액티브 선언문
- 리액티브 선언문: 사람들이 스마트폰, 데스크톱 애플리케이션 등 여러 기기에 포함된 애플리케이션이 요청에 즉각 응답하고 항상 가동되길 기대하는 것을 잘 표현한 문서
- 리액티브 시스템: 응답성, 탄력성, 유연성, 메시지 기반(Message Driven) 4가지 특성을 강조하고, 이러한 요건을 만족하는 시스템
  - 응답성: 사용자에게 신뢰성 있는 응답을 빠르고 적절하게 제공
  - 탄력성: 장애가 발생하거나 부분적으로 고장 나더라도 시스템 전체가 고장 나지 않고 빠르게 복구하는 능력
  - 유연성: 사용량에 변화가 있더라도 균일한 응답성을 제공, 사용량에 비례해서 자원을 늘리거나 줄이는 능력
  - 메시지 기반: 비동기 메시지 전달을 통해 위치 투명성, 느슨한 결합, 논블로킹 통신을 지향
- 아키텍처 유연성
  - 리액티브 시스템이 반드시 갖춰야 할 공통적인 특성
  - 시스템을 구성하는 구성요소 간의 관계들이 느슨하게 맺어져 있어 언제든지 대체되거나 추가 확장될 수 있는 특성 
  - 위의 4가지 요소 중에서 '메시지 기반'이라는 요소가 아키텍처 유연성을 만족시키는 요소이다.
  - 메시지 기반 특성은 이후에 살펴볼 마이크로서비스 아키텍처에서도 마이크로서비스 간의 의존성을 줄이는 중요한 특성이 된다.

## 2.2 강 결합에서 느슨한 결합의 아키텍처로의 변화

### 과거의 아키텍처
- 아키텍처 구성요소들을 각 기업이나 특정 벤더의 제품에 전적으로 의존해서 구축하거나 수정이 필요한 부분만 별도로 직접 개발하는 경우가 많았다.
- 특정 벤더 솔루션이나 프레임워크가 변경될 경우 그것에 의존하는 애플리케이션의 많은 부분들을 변경해야 할 정도로 강 결합돼 있었다.
- 검증된 유명 제품군을 사용한다는 점에서 품질이 보장된다고 생각할 수 있는 반면, 특정 기술에 락인되어 쉽게 변경되거나 확장하지 못한다는 단점이 있다.

### 최근의 아키텍처
- 최근에 분위기를 바꿔 하나의 벤더에 의존하거나 직접 구출할 필요가 적어졌다.
  - 왜냐하면 클라우드 환경에서 사용되는 오픈소스 또는 오픈소스를 기반으로 한 상용 제품들이 이전의 유명 벤더의 제품군 만큼이나 품질이 높아지고 다양한 기능을 지원하면서 서로 다른 오픈소스 제품간에도 호환성이 높아졌기 때문이다.
- 이러한 흐름은 아키텍처 설계 활동에도 변화를 가져왔다.
  - 예전에는 검증된 기술이나 솔루션을 기반으로 기술을 직접 구현하는 폐쇄적인 방식
  - 최근의 아키텍처 설계는 필요한 영역에 적절한 솔루션을 선택하고 조합하는 개방적인 방식으로 바뀜 

### 2.3 마이크로서비스의 외부 아키텍처와 내부 아키텍처

![KakaoTalk_Photo_2023-01-11-12-29-35](https://user-images.githubusercontent.com/28394879/211711352-af7feceb-86d2-4995-b5f4-2af0cf24175a.jpeg)
- 밑에서부터 인프라, 플랫폼, 애플리테이션 영역으로 구분
- 각 관계
  - 맨 아래에 기반이 되는 하드웨어 인프라 
  - 인프라 영역위에 애플리케이션을 운영 및 구동하기 위한 플랫폼
  - 플랫폼 위에 애플리케이션인 서비스가 구독 
- MSA 외부 아키텍처
  - 인프라 영역과 플랫폼 영역, 애플리케이션 영역에 있는 구성 요소 및 그것들의 관계를 정의
  - 마이크로서비스가 운영되는 환경을 정의
  - 인프라 환경, 플랫폼 환경, 마이크로서비스가 운영되는 애플리케이션 환경이 모두 포함, 특히 애플리케이션 측면에서는 여러 개의 마이크로서비스를 관리하고 운영하기 위한 애플리케이션도 모두 포함
  - 이러한 환경을 클라우드 아키텍처가 요구하는 유연성과 확장성을 고려해서 정의해야 함
- MSA 내부 아키텍처
  - 실제로 비즈니스가 실행되는 비즈니스 애플리케이션, 즉 각 MSA의 내부 구조를 정의
  - MSA가 제공하는 API, 비즈니스 로직, 이벤트 발행, 데이터 저장 처리 등을 어떻게 구조화해야 하는가에 대한 내용 
  - 당연히 이 구조도 변화에 적응 가능하도록 유연하고 확장성 있게 구현해야 함
